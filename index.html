<html>
<head>
	<style type="text/css">
		.title {
			display: inline;
		}
		.box {
			border: 1px solid black;
			width: 45%;
			height: 40%;
			margin: 10px;
			padding: 10px;
			border-radius: 15px;
			float: left;
		}
		.record-text {
			width: 80%;

		}
		.clear {
			clear: both;
		}
	</style>
</head>
<body>
	<div>
		<h1 class="title"></h1> <button id="next-sprint">Migrate to Next Sprint</button> <button id="clear-data">Delete</button>
	</div>
	<div class="box" data-section="good" data-section-display="Things We Did Well">
		<div class="add-record"><input type="text" class="record-text" /><button class="add">+</button></div>
	</div>
	<div class="box" data-section="last" data-section-display="Last Sprint"></div>
	<div class="box" data-section="bad" data-section-display="Things We Did Poorly">
		<div class="add-record"><input type="text" class="record-text" /><button class="add">+</button></div>
	</div>
	<div class="box" data-section="solutions" data-section-display="Solutions">
		<div class="add-record"><input type="text" class="record-text" /><button class="add">+</button></div>
	</div>
	
	<br class="clear"/>
	<button id="print">Print</button>
	<div id="print-display"></div>
</body>
<script type="text/javascript">
	document.addEventListener("DOMContentLoaded", function() {
		var addButtons = document.getElementsByClassName("add");
		for(var i =0, button; button = addButtons[i]; i++) {
			button.addEventListener("click", addButton_click);
		}

		addLabels();
		loadStoredContent();

		var printButton = document.getElementById("print");
		printButton.addEventListener("click", print_click);

		var migrateButton = document.getElementById("next-sprint");
		migrateButton.addEventListener("click", migrateSprint);

		var clearButton = document.getElementById("clear-data");
		clearButton.addEventListener("click", clearData);

		
	});

	function addButton_click(event) {
		var container = this.parentElement.parentElement;
		var section = container.getAttribute("data-section");
		var sectionData = JSON.parse(localStorage.getItem(section));

		var inputField = this.parentElement.getElementsByClassName("record-text")[0];
		var recordToInput = inputField.value;
		var recordId = sectionData.length;
		var recordData = {"text" : recordToInput};
		
		displayRecordInContainer(container, section, recordData, recordId);
		
		inputField.value = "";
		
		sectionData.push(recordData);
		localStorage.setItem(section, JSON.stringify(sectionData));
	}

	function print_click(event) {
		var boxes = document.getElementsByClassName("box");
		var printDisplay = document.getElementById("print-display");	


		for(var i = 0, box; box = boxes[i]; i++) {
			box.style.display = "none";
			var section = box.getAttribute("data-section");
			var sectionDisplay = box.getAttribute("data-section-display");
			printDisplay.innerHTML += "<h2>" + sectionDisplay + "</h2>";
			var sectionStorage = localStorage.getItem(section);
			var listContainer = document.createElement('ul');
			if(sectionStorage != null) {
				var sectionData = JSON.parse(sectionStorage);
				for(var r = 0, record; record = sectionData[r]; r++) {
					var listItem = document.createElement("li");
					listItem.innerHTML = record.text;
					listContainer.appendChild(listItem);
				}
			}
			printDisplay.appendChild(listContainer);
		}
		this.style.display = "none";
		var clearButton = document.getElementById("clear-data");
		clearButton.style.display = "none";

		var migrateButton = document.getElementById("next-sprint");
		migrateButton.style.display = "none";
	}

	function migrateSprint(event) {
		var response = confirm("Are you sure you want to migrate this retrospective?");
		if(response) {
			var solutions = JSON.parse(localStorage.getItem('solutions'));
			localStorage.clear();
			localStorage.setItem('last', JSON.stringify(solutions));
			location.reload();
		}
	}

	function clearData(event) {
		var response = confirm("Are you sure you want to delete this retrospective?");
		if(response) {
			localStorage.clear();
			location.reload();
		}
	}

	function saveEditItem_click(event) {
		var recordElement = this.parentElement;
		var container = recordElement.parentElement;
		var section = container.getAttribute("data-section");
		var recordId = recordElement.getAttribute("data-record-id");

		var inputField = recordElement.getElementsByClassName("record-edit")[0];
		var recordToInput = inputField.value;
		var recordData = {"text" : recordToInput};
		
		var sectionData = JSON.parse(localStorage.getItem(section));

		sectionData[recordId] = recordData;
		localStorage.setItem(section, JSON.stringify(sectionData));

		container.removeChild(recordElement);

		displayRecordInContainer(container, section, recordData, recordId);
	}

	function cancelEditItem_click(event) {
		location.reload();
	}

	function editItem_click(event) {

		var recordElement = this.parentElement;
		var container = recordElement.parentElement;
		var recordId = recordElement.getAttribute("data-record-id");

		var text = recordElement.getElementsByTagName('span')[0].innerHTML;
		

		displayEditRecord(container, text, recordId);

		container.removeChild(recordElement);
		console.log("edit", text, recordElement, container);
	}

	function deleteItem_click(event) {
		var record = this.parentElement;
		var container = record.parentElement;
		var response = confirm("Are you sure you want to delete \"" + record.getElementsByTagName('span')[0].innerHTML + "\"?");
		if(response) {
			var recordId = record.getAttribute("data-record-id");
			var section = container.getAttribute("data-section");

			var sectionStorage = JSON.parse(localStorage.getItem(section));
			var newSectionStorage = [];
			for(var i = 0; i < sectionStorage.length; i++) {
				if(i != recordId) {
					newSectionStorage.push(sectionStorage[i]);
				}
			}

			localStorage.setItem(section, JSON.stringify(newSectionStorage));

			container.removeChild(record);
		}
	}

	function displayEditRecord(container, contents, id) {
		var recordContainer = document.createElement("div");

		var inputField = document.createElement("input");
		inputField.type = "text";
		inputField.value = contents;
		inputField.className = "record-edit";

		var saveButton = document.createElement("button");
		saveButton.innerHTML = "Save";
		saveButton.addEventListener("click", saveEditItem_click);
		
		recordContainer.className = "record-edit";
		recordContainer.setAttribute("data-record-id", id);

		var editButton = document.createElement("button");
		editButton.innerHTML = "...";
		editButton.addEventListener("click", editItem_click);

		var cancelButton = document.createElement("button");
		cancelButton.innerHTML = "Cancel";
		cancelButton.addEventListener("click", cancelEditItem_click);

		recordContainer.appendChild(inputField);
		recordContainer.appendChild(saveButton);
		recordContainer.appendChild(cancelButton);
		container.appendChild(recordContainer);
	}

	function displayRecordInContainer(container, section, record, id) {
		var recordContainer = document.createElement("div");

		var textContainer = document.createElement("span");
		textContainer.innerHTML = record.text;
		
		recordContainer.className = "record";
		recordContainer.setAttribute("data-record-id", id);

		var editButton = document.createElement("button");
		editButton.innerHTML = "...";
		editButton.addEventListener("click", editItem_click);

		var deleteButton = document.createElement("button");
		deleteButton.innerHTML = "X";
		deleteButton.addEventListener("click", deleteItem_click);

		recordContainer.appendChild(textContainer);
		recordContainer.appendChild(editButton);
		recordContainer.appendChild(deleteButton);
		container.appendChild(recordContainer);
		
	}

	function loadStoredContent() {
		var boxes = document.getElementsByClassName("box");
		for(var i = 0, box; box = boxes[i]; i++) {
			loadSection(box);
		}

		
		var titleString = localStorage.getItem("title");
		if(titleString == null) {
			titleString = "Retrospective for " + new Date().toLocaleDateString();	
			localStorage.setItem("title", titleString);
		}
		var title = document.getElementsByClassName("title")[0];
		title.innerHTML = titleString;
		
	}

	function loadSection(container) {
		var section = container.getAttribute("data-section");
		var sectionStorage = localStorage.getItem(section);
		if(sectionStorage == null) {
			localStorage.setItem(section, JSON.stringify([]));
		} else {
			var sectionData = JSON.parse(sectionStorage);
			for(var i = 0, record; record = sectionData[i]; i++) {
				displayRecordInContainer(container, section, record, i);
			}
		}
	}

	function addLabels() {
		var boxes = document.getElementsByClassName("box");
		for(var i = 0, box; box = boxes[i]; i++) {
			var sectionDisplay = box.getAttribute("data-section-display");
			var sectionHeader = document.createElement("h2");
			sectionHeader.innerHTML = sectionDisplay;
			box.appendChild(sectionHeader);
		}
	}
</script>
</html>